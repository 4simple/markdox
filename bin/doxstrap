#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander')
  , util = require('util')
  , format = util.format
  , async = require('async')
  , doxstrap = require('../')
  , fs = require('fs')
  , docs = []
  , basePath = process.cwd();

// options

program
  .version(doxstrap.version)
  .option('-o, --output <filepath>', 'specify filepath to output [output.md]', String, 'output.md')
  .command('doxstrap [options]... files...');

// examples

program.on('--help', function(){
  console.log('  Examples:');
  console.log('');
  console.log('    $ doxstrap myfile.js');
  console.log('    $ doxstrap myfile1.js myfile2.js');
  console.log('');
});

// parse argv
program.parse(process.argv);

// loop over files

async.forEach(program.args, function(arg, callback){

  doxstrap.parse(arg, function(err, doc){
    docs.push(doc);
    callback(err);
  });

}, function (err) {
  console.log('Generation starting');

  doxstrap.generate(docs, function(err, output){
    fs.writeFile(basePath + '/' + program.output, output, 'utf-8', function(){
      console.log('Generation finished');
    });
  });

});